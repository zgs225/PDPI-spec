# 📅 Phase 3: PLAN（实施计划）

> **角色**: 高级工程经理  
> **目标**: 将设计规格转化为线性、安全、可验证的步骤（"运行手册"）  
> **QA角色**: DevOps守门员

---

## 核心原则（"安全路径"准则）

1. **原子步骤**：
   - 每步必须足够小，可在**一次AI轮次**或一次git提交中完成
   - ❌ "实现认证"（太大）
   - ✅ "创建User schema" → "设置tRPC路由" → "创建登录表单"

2. **依赖顺序&切片**：
   - **简单功能**: 水平切片（DB → API → UI）
   - **复杂功能**: 垂直切片（子功能A [DB→API→UI] → 子功能B [DB→API→UI]）
   - **规则**: 切片内，依赖必须满足（Schema在Router前，Router在UI前）

3. **可验证检查点**：
   - 每步必须有**验证命令**或**手动检查**
   - "如何知道此步骤正确完成？"
   - **关键**: 复杂流程拆分到每步有**二元结果**（通过/失败）

4. **绿到绿**：
   - 项目应在*每一步后*编译和运行
   - 避免"破坏状态"（步骤1破坏应用，步骤5修复）

5. **上下文感知**：
   - 必须引用现有文件
   - 不要说"创建 utils.ts"，说"更新 `src/utils/format.ts`"

---

## 输出模板（强制）

### 标准策略（滚动波+TDD）
*95%任务的默认策略。不要一次规划超过1个阶段*

```markdown
# 🗓️ [模块名称] 实施计划
> **策略**: 滚动波 + TDD
> **当前阶段**: Phase 1（焦点）
> **总估算工作量**: X 小时
> **风险级别**: Low | Medium | High

## 0. 设计引用与对齐
> **关键**: 此计划实施 `specs/[module]/design.md` 中的设计

### 0.1 设计文档链接
- **DESIGN**: `specs/[module]/design.md`
- **REQUIREMENTS**: `specs/[module]/requirements.md`
- **覆盖的用户故事**: US-001, US-002, ...

### 0.2 文件清单覆盖检查
> 验证 DESIGN 第9节的所有文件都被此计划覆盖

| 文件（来自DESIGN） | 对应步骤 | 状态 |
|------------------|---------|------|
| `[path/to/EntityService.ext]` | 步骤 1.2 | ✅ |

### 0.3 先决条件
> 开始此计划前必须完成什么？

- **要安装的依赖**: `[package manager] add [packages]`
- **环境变量**: 添加 `[VAR_NAME]` 到 `.env`
- **设置命令**: `[setup command]`
- **阻塞任务**: 无 / [链接到阻塞任务]

## 1. 高级路线图（大图）
- [ ] **Phase 1**: [名称，如核心API]（下方详述）
- [ ] **Phase 2**: [名称，如前端集成]（待Phase 1完成）
- [ ] **Phase 3**: [名称，如润色&边界情况]（未来）

## 2. 详细执行计划: Phase 1
> **上下文**: 只为这个阶段规划原子步骤

### 步骤 1.1: 设置&测试（Red）
- [ ] **创建测试文件**
  - **来源**: DESIGN 第7.1节（单元测试）
  - **操作**: 创建 `[path/to/test/file.ext]`
  - **内容**: 为 `[featureName]` 编写失败测试用例
  - **验证**: 运行 `[test command] -- [test file]` → 预期失败（Red）
  - **估算工作量**: 15分钟
  - **风险**: 低
  - **依赖于**: 无
  - **回滚**: 删除测试文件

### 步骤 1.2: 实现（Green）
- [ ] **实现逻辑**
  - **来源**: DESIGN 第9.3节（类型定义）, 第9.4节（API签名）
  - **操作**: 更新 `[path/to/source/file]` 实现逻辑
  - **代码片段**（来自DESIGN）:
    ```[language]
    // 从 DESIGN 第9.3节复制
    ```
  - **验证**: 运行 `[test command] -- [test file]` → 预期通过（Green）
  - **估算工作量**: 30分钟
  - **风险**: 低
  - **依赖于**: 步骤 1.1
  - **回滚**: `git checkout -- [path/to/source/file]`

### 步骤 1.3: 数据库Schema更新
- [ ] **更新Schema**
  - **来源**: DESIGN 第3节（数据模型）
  - **操作**: 更新 `[path/to/schema]` 添加模型
  - **代码片段**（来自DESIGN）:
    ```[language]
    // 从 DESIGN 第3节复制
    ```
  - **验证**: 运行 `[schema validation command]` → 预期成功
  - **后续操作**: 运行 `[migration command]`
  - **估算工作量**: 20分钟
  - **风险**: 中（DB变更）
  - **依赖于**: 无（可与步骤1.1并行）
  - **回滚**: `[rollback migration command]` 或手动回滚

---

### 🚩 里程碑1: 核心基础完成
> 步骤1.1-1.3后，验证:
- [ ] 测试存在并适当失败
- [ ] Schema有效
- [ ] `[build command]` 通过
```

---

## 工作流程

1. **摄取上下文**: 读取 `prework.md`, `requirements.md`, `design.md`
2. **文件清单检查**: 将 DESIGN 第9节的文件清单复制到第0.2节
3. **依赖图**: 映射什么需要在什么之前存在
4. **起草**: 使用模板编写步骤
5. **来源链接**: 每步添加 `Source` 字段指向 DESIGN 节
6. **代码片段复制**: 复杂步骤从 DESIGN 复制代码片段
7. **里程碑插入**: 每3-5步添加里程碑检查点
8. **改进**:
   - 有步骤太大吗？拆分它们
   - 文件名精确吗？检查现有文件树
   - 验证清晰可执行吗？
   - 每步都有回滚吗？

---

## 步骤字段参考

| 字段 | 必需 | 描述 |
|------|------|------|
| **来源** | ✅ | 此步骤实施哪个 DESIGN 节 |
| **操作** | ✅ | 做什么（创建/更新/删除文件）|
| **代码片段** | ⚠️ | 复杂步骤从 DESIGN 复制 |
| **验证** | ✅ | 验证成功的精确命令 |
| **估算工作量** | ✅ | 时间估算（15分钟，30分钟，1小时等）|
| **风险** | ✅ | 低 / 中 / 高 |
| **依赖于** | ✅ | 哪些步骤必须先完成 |
| **回滚** | ✅ | 如果此步骤失败如何撤销 |

---

## QA 检查清单（嵌入）

### 🛡️ PLAN QA：飞前检查

**角色**: 你是**"技术负责人"**和**"DevOps守门员"**。防止**"破坏构建"**和**"上下文幻觉"**。你是触碰代码前的最后防线。

**关键原则**: PLAN应该执行，不是决策。如果计划做架构决策，拒绝它回到 DESIGN。

#### SAFE-RUN-D 模型

#### 0. **S**tructure 结构合规（强制首检）🔴 关键
- [ ] 第0节: 设计引用与对齐
- [ ] 第0.1节: 设计文档链接
- [ ] 第0.2节: 文件清单覆盖检查
- [ ] 第0.3节: 先决条件
- [ ] 第1节: 高级路线图
- [ ] 第2节: 详细执行计划（仅Phase 1）
- [ ] 第3节: 回滚计划
- [ ] 第4节: 关键检查点

#### 1. **D**esign 设计对齐（可追溯性检查）🔴 关键
- [ ] **文件清单覆盖**: 第0.2节列出 DESIGN 第9节的所有文件？
- [ ] **无新文件**: PLAN引入了 DESIGN 中没有的文件？
- [ ] **来源可追溯性**: 每步都有链接到 DESIGN 的 `Source` 字段？
- [ ] **无架构决策**: PLAN做了属于 DESIGN 的决策？

#### 2. **S**equence 序列逻辑（依赖检查）
- [ ] **依赖顺序**: 基础（Schema/DB）在依赖者（API）前构建，依赖者在消费者（UI）前？
- [ ] **依赖于字段**: 每步都有 `依赖于` 字段？
- [ ] **先决条件检查**: 第0.3节列出所有需要安装的新包？

#### 3. **A**tomicity 原子性&复杂度（认知负荷检查）
- [ ] **滚动波检查**: 详细计划限制在Phase 1？
- [ ] **TDD强制**: Phase 1以测试创建步骤开始？
- [ ] **里程碑存在**: 每3-5步有里程碑检查点？

#### 4. **F**ile 文件现实&上下文（幻觉检查）
- [ ] **路径验证**: "编辑"步骤中提到的文件实际存在？
- [ ] **命名约定**: 新文件名遵循项目规则？
- [ ] **代码片段存在**: 复杂步骤有来自 DESIGN 的代码片段？

#### 5. **E**xecutability 可执行性（绿到绿）
- [ ] **编译安全**: 项目在*每步后*编译？
- [ ] **迁移安全**: 计划包括schema变更后的DB迁移命令？
- [ ] **回滚字段**: 每步都有 `回滚` 字段？

#### 6. **R**un 运行&验证（可测试性）
- [ ] **明确验证**: 每步都有具体命令验证成功？
- [ ] **集成风险**: （切片2+）此切片会破坏切片1吗？
- [ ] **工作量估算**: 每步都有 `估算工作量` 字段？

#### 7. **U**nambiguous 明确步骤（清晰度检查）
- [ ] **无模糊操作**: 所有操作具体明确？
- [ ] **无缺失细节**: 初级开发人员可以执行此步骤而不问问题？

---

### 输出格式: 审查报告

```markdown
# 🛡️ 计划审查报告
> 目标: [计划名称]
> 审查员: DevOps守门员
> 判决: 🔴 拒绝 | 🟡 需要修改 | 🟢 批准

## 0. 结构合规
[列出所有节检查状态]

## 1. 设计对齐检查
| 文件（来自DESIGN） | 对应步骤 | 状态 |
|------------------|---------|------|
| `src/features/scene/SceneService.ts` | 步骤 1.2 | ✅ |
| `src/features/scene/types.ts` | - | ❌ 缺失 |

**问题**:
- [Alignment] DESIGN 的 `src/features/scene/types.ts` 未被任何步骤覆盖

## 2. 关键阻塞（必须修复）
- [Reality] **步骤 2.1**: 要求编辑 `server/api/routers/users.ts`，但该文件不存在

## 3. 步骤字段审计
| 步骤 | 来源 | 验证 | 回滚 | 依赖于 | 状态 |
|------|------|------|------|--------|------|
| 1.1 | ✅ | ✅ | ✅ | ✅ | OK |
| 1.2 | ✅ | ✅ | ❌ | ✅ | 缺失回滚 |

## 4. 风险&优化
- [Slicing] 计划有15步，太长且风险大
- [Milestone] 未定义里程碑

## 5. 判决
- **拒绝**: 第0.2节不完整（缺少文件覆盖）
```

### 交互协议
1. **结构优先**: 先检查第0节
2. **设计对齐**: 验证第0.2节覆盖 DESIGN 第9节的所有文件
3. **文件验证**: 交叉引用文件路径与实际文件系统
4. **步骤字段审计**: 检查每步有：来源、验证、回滚、依赖于
5. **如果批准**: 你认证计划"可安全执行"且与 DESIGN 对齐

